echo "== 5. Génération des fichiers reverse proxy =="
mkdir -p nginx-reverse-proxy

# Fichier de configuration NGINX
cat > nginx-reverse-proxy/nginx.conf <<EOF
events {}

http {
    server {
        listen 80;
        server_name web1.local;
        location / {
            proxy_pass http://$WEB1_IP/;
        }
    }
    server {
        listen 80;
        server_name web2.local;
        location / {
            proxy_pass http://$WEB2_IP/;
        }
    }
    server {
        listen 80;
        server_name web3.local;
        location / {
            proxy_pass http://$WEB3_IP/;
        }
    }
}
EOF

# Dockerfile pour NGINX reverse-proxy
cat > nginx-reverse-proxy/Dockerfile <<EOF
FROM nginx:alpine
COPY nginx.conf /etc/nginx/nginx.conf
RUN rm /etc/nginx/conf.d/default.conf || true
EOF

echo "== 6. Build & Run NGINX reverse proxy (docker) =="
cd nginx-reverse-proxy
docker build -t $PROXY_IMG .
docker rm -f $PROXY_CTR 2>/dev/null || true
docker run -d -p 80:80 --name $PROXY_CTR --network host $PROXY_IMG
cd ..
